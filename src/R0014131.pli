 /*   SIST ENDRET PÅ PROD   2007.03.14  8.32.22 AV   JDA2990          */        
 /*   SIST ENDRET PÅ TEST   2007.02.28  8.35.42 AV   JDA2990          */        
 /*   SIST ENDRET PÅ QASS   2006.09.22  8.21.41 AV   JDA2990          */        
 /*   SIST ENDRET PÅ PROD   2005.11.18 14.47.13 AV   JDA2970          */        
 /*   SIST ENDRET PÅ PROD   2003.08.14 12.32.07 AV   JDA2970          */        
 /*   SIST ENDRET PÅ TEST   2003.08.12 11.26.05 AV   JDA2970          */        
 /*   SIST ENDRET PÅ PROD   2002.06.04 10.19.30 AV   HLA2970          */        
 /*   SIST ENDRET PÅ PROD   2001.01.24 10.29.08 AV   HLA7339          */        
 /*   SIST ENDRET PÅ PROD   2000.11.06 12.52.50 AV   HLA7339          */        
 /*   SIST ENDRET PÅ PROD   2000.10.25 13.39.04 AV   HLA7339          */        
 /*   SIST ENDRET PÅ PROD   2000.06.22 14.21.54 AV   JDA7339          */        
 /*   SIST ENDRET PÅ PROD   2000.04.26  9.30.55 AV   JDA7339          */        
 /*   SIST ENDRET PÅ PROD   2000.02.03  9.01.04 AV   JDA7339          */        
 /*   SIST ENDRET PÅ PROD   2000.01.11  8.41.44 AV   JDA7339          */        
 /*   SIST ENDRET PÅ PROD   1999.11.23 12.17.01 AV   JDA7339          */        
 /*       SIST ENDRET 12/10-99 11.45.19 AV   JDA7339                  */        
 /*       SIST ENDRET 12/10-99 11.42.37 AV   JDA7339                  */        
 /*       SIST ENDRET 21/09-99 08.19.18 AV   JDA7339                  */        
 /*       SIST ENDRET 21/09-99 08.15.39 AV   JDA7339                  */        
 /*       SIST ENDRET 03/03-99 14.13.19 AV   JDA7339                  */        
 /*       SIST ENDRET 03/03-99 14.11.13 AV   JDA7339                  */        
 /*       SIST ENDRET 19/08-98 09.28.25 AV   TSB7339                  */        
 /*       SIST ENDRET 20/07-98 10.03.35 AV   JDA7339                  */        
 /*       SIST ENDRET 22/06-98 08.58.26 AV   RFA9991                  */        
 /* ***************************************************************** */        
 /*IDENTIFIKASJON:                                                    */        
 /*    R0014131 - BEREGN_TP_ETTERLATT_AP - UNDERPROGRAM I PLI         */        
 /*    PROGRAMMERER: KRISTENSEN, APRIL 1982                           */        
 /*    ENDRET JULI 82 AV KARIN,TOTALT ENDRET AV R.FARVIK.             */        
 /*HENSIKT:                                                           */        
 /*    PROGRAMMET REGNER UT EGEN TP OG 55 PROSENT AV EGEN OG AVDØDES  */        
 /*    TP, VELGER HØYESTE TP, OPPDATERER B02 MED TP, SLUTTPOENGTALL,  */        
 /*    OVERKOMP.POENGTALL OG POENGÅR.                                 */        
 /*    OPPDATERER EVT. YRKEPENS.YPT OG YPT_KODE FOR AVDØDE            */        
 /*PROGRAMTILKNYTNING:                                                */        
 /*    PROGRAMMET BLIR INKLUDERT I RXX14101-(BEREGN_ETTERLATT_AP)     */        
 /*    OG CALLET FRA               RXX14121-(BEREGN_ETTERLATT_AP_DEL1)*/        
 /*BRUK:                                                              */        
 /*    CALL BEREGN_TP_ETTERLATT_AP                                    */        
 /*ENDRING:                                                           */        
 /*    DET ER LAGT INN FJERNING AV POENGILLEGGSOPPLYSNINGER NÅR DET   */        
 /*    IKKE GIS POENGTILLEGG LENGER           6/2 84   OLAV           */        
 /*ENDRING:                                                           */        
 /*    DET ER GJORT ENDRING I BEREGNINGEN AV TP NåR SIVILSTAND = S    */        
 /*                                          28/3 85  J.Y. DYBVIK     */        
 /*ENDRING:                                                           */        
 /*    SKILT PERSON SKAL HA POENGTILLEGG                              */        
 /*                                          29.5.85 HERMAN LARSSEN   */        
 /*ENDRING:                                                           */        
 /*    SKILT PERSON MED '0' PROSENT AV AVDØDES TP FÅR LIKEVEL         */        
 /*    IKKE POENGTILLEGG - FRAPP 302.                                 */        
 /*                                          28.1.86 HERMAN LARSSEN   */        
 /*ENDRING 28.11.86 - HL                                            */          
 /*    VALG AV POENGREKKE SKAL FORETAS ETTER EN SAMMENLIGNING       */          
 /*    AV PENSJON MED EVT. POENGTILLEGG. ALTERNATIV POREKKE ER      */          
 /*    LAGT UT PÅ PLASS 12(KVINNE) ELLER 13(MANN).                  */          
 /*ENDRING 23.10.90 - TS UNGE UFØRE FØR 1967 FÅR ENDRET SPT_GARANTI */          
 /*                      FRA 1.6 TIL 2 FRA 0191.                    */          
 /* *************************************************************** */          
 BEREGN_TP_ETTERLATT_AP: PROC;                                                  
    DCL                                                                         
       ALDER              PIC 'S99999',                                         
       ALDER_VED_DØD      PIC 'S999999'   INIT (0),  /*HL*/                     
       DØDSDATO_ÅM        PIC '9999'      INIT (0),  /*HL*/                     
       DØDSDATO_ÅMD       PIC '(8)9',                                           
       DØDSÅR             DEF DØDSDATO_ÅMD POS(1) PIC '9999',                   
       FAKTOR1            FIXED DEC (13,6)  INIT (0),                           
       FAKTOR2            FIXED DEC (13,6)  INIT (0),                           
       FIXED_DEC7         FIXED DEC (7)    INIT (0),  /*HL*/                    
       FORHØY_IND         CHAR(1),                                              
       1 FNR_EK_R13       DEF W_FNR_EK13,                                       
         2 DAG            PIC'( 2)9',                                           
         2 MND            PIC'( 2)9',                                           
         2 ÅR             PIC'( 4)9',                                           
         2 FILLER         PIC'( 5)9',                                           
       1 FNR_R13          DEF W_FNR13,                                          
         2 DAG            PIC'( 2)9',                                           
         2 MND            PIC'( 2)9',                                           
         2 ÅR             PIC'( 4)9',                                           
         2 FILLER         PIC'( 5)9',                                           
       FRADRAG            FIXED DEC ( 3  )            INIT(0),                  
       K                  FIXED BIN (15),                                       
       PÅ_ETTER91_EK      CHAR (1)                    INIT('N'),                
       PÅ_ETTER91_SØKER   CHAR (1)                    INIT('N'),                
       PÅ_FØR92           FIXED DEC ( 3  )            INIT(0),                  
       RETUR_POENG        FIXED DEC ( 3,2)            INIT(0),                  
       SISTE_UFØRHIST     FIXED DEC ( 5  )            INIT(0),                  
       SISTE_UFØRHIST_EK  FIXED DEC ( 5  )            INIT(0),                  
       SPT_GARANTI        FIXED DEC ( 3,2)            INIT(0),                  
       TP_EK              FIXED DEC ( 7  )            INIT(0),                  
       TP_GARANTI         FIXED DEC (11,4),                                     
       TP_GARANTI1        FIXED DEC ( 5  ),                                     
       W2_TP              FIXED DEC ( 7  )            INIT(0),                  
       W_FNR              PIC'(11)9',                                           
       W_FNR13            PIC'(13)9',                                           
       W_FNR_EK           PIC'(11)9',                                           
       W_FNR_EK13         PIC'(13)9',                                           
       W_GAR_TP           FIXED DEC ( 5  ),                                     
       W_GARANTI_TP       FIXED DEC (11,4),                                     
       W_TP_ALT           FIXED DEC ( 7  )            INIT(0),                  
       W_TP               FIXED DEC ( 7  )            INIT(0),                  
       W_VIRK_ÅM          FIXED DEC ( 7  )            INIT(0),                  
       W_ÅR_E91           FIXED DEC ( 3  )            INIT(0),                  
       ÅR_E91             FIXED DEC ( 3  )            INIT(0);                  
                                                                                
    /* ============================================================== */        
                                                                                
    B02.TP_GAR_KODE(BER_SØ_IND) = ' ';      /*200608 HL*/                       
    DØDSDATO_ÅMD     = B02.DØDSDATO_ÅMD(BER_EK_IND);                            
    W_FNR_EK         = B02.FNR(BER_EK_IND);                                     
    W_FNR_EK13       = KONV_FNR11_FNR13(W_FNR_EK);                              
    ÅR_E91            = 0;                                                      
    W_FNR            = B02.FNR(BER_SØ_IND);                                     
    W_FNR13          = KONV_FNR11_FNR13(W_FNR);                                 
    ALDER = F_ALDER(W_FNR,(B02.VIRK_DATO_ÅMD(BER_SØ_IND)));                     
                                                                                
    B01_B02_IND     = 2;                                                        
    POTALL_OPPL.IND = BER_SØ_IND;                                               
                                                                                
    EXEC CICS LINK PROGRAM ('R0014141') COMMAREA(KOM_OMR);                      
                                                                                
    DO K = 7 TO 1 BY - 1 UNTIL(B02.UFØRHIST.UFT_ÅMD(BER_EK_IND,K) > 0);         
       SISTE_UFØRHIST_EK  = K;                                                  
    END;                                                          /*93*/        
    DO K = 7 TO 1 BY - 1 UNTIL(B02.UFØRHIST.UFT_ÅMD(BER_SØ_IND,K) > 0);         
       SISTE_UFØRHIST     = K;                                                  
    END;                                                          /*93*/        
                                                                                
    B02.ALDERSP.PÅ_ETTER91(BER_SØ_IND) =                                        
                              POREKKE.PÅ_ETTER91(BER_SØ_IND);                   
                                                                                
    IF (B02.UFØRHIST.UFT_ÅMD(BER_SØ_IND,SISTE_UFØRHIST) < 19730000)  &          
       (B02.OPPHØRSKODE(BER_SØ_IND,SISTE_UFØRHIST)     = 'A') THEN              
         B02.ALDERSP.PÅ_ETTER91(BER_SØ_IND) = 0;                                
    ELSE                                                                        
    IF (FNR_R13.ÅR > 1925) &                                                    
       ((B02.KONV_P_KODE(BER_SØ_IND)    = 'K'   &                               
         B02.UTTAKSDATO_ÅMD(BER_SØ_IND)  < 19920000 )    !                      
                                                                                
        ((B02.KONV_P_KODE(BER_SØ_IND)    = 'U'   !                              
          B02.KONV_P_KODE(BER_SØ_IND)    = 'Y' ) &                              
          B02.UFØRHIST.UFT_ÅMD(BER_SØ_IND,SISTE_UFØRHIST) < 19920000))          
                    THEN                                                        
       DO;                                                                      
           POREKKE_P67.PÅ_ETTER91(BER_SØ_IND) = 0;                              
           FRADRAG = FNR_R13.ÅR - 1925;                                         
           IF FRADRAG > POREKKE.PÅ_ETTER91(BER_SØ_IND)    THEN                  
              B02.ALDERSP.PÅ_ETTER91(BER_SØ_IND)  = 0;                          
           ELSE                                                                 
              DO;                                                               
                 B02.ALDERSP.PÅ_ETTER91(BER_SØ_IND)  =                          
                 POREKKE.PÅ_ETTER91(BER_SØ_IND) - FRADRAG;                      
                 POREKKE.PÅ_ETTER91(BER_SØ_IND) =                               
                 B02.ALDERSP.PÅ_ETTER91(BER_SØ_IND);                            
                 POREKKE.PÅ_ETTER91(BER_SØ_IND + 11) =                          
                 B02.ALDERSP.PÅ_ETTER91(BER_SØ_IND);                            
              END;                                                              
        END;                                                                    
     IF B02.ALDERSP.PÅ_ETTER91(BER_SØ_IND) > 0   THEN                           
        PÅ_ETTER91_SØKER = 'J';                                                 
     ELSE                                                                       
        DO;                                                                     
           PÅ_ETTER91_SØKER = 'N';                                              
           POREKKE.PÅ_ETTER91(BER_SØ_IND) = 0;                                  
           POREKKE_P67.PÅ_ETTER91(BER_SØ_IND) = 0;                              
        END;                                                                    
                                                                                
     POREKKE(14)             = POREKKE(BER_SØ_IND);                             
     /* PLASS 14 BRUKES SOM OPPBEVARINGSOMR. DA DENNE PLASSEN     */            
     /* ALLTID ER LEDIG I ALDERSPENSJON.                          */            
                                                                                
     W_POREKKE               = POREKKE_P67(BER_SØ_IND);                         
                                                                                
     IF FEIL_MELD_NR > 0  THEN                                                  
        GO TO RETUR;                                                            
     ELSE                                                                       
        PROGRAM_ID = 'R0014101';                                                
                                                                                
     /* HER REGNES ENSLIG TILLEGGSPENSJON UT    */                              
     IF POREKKE.PÅ(BER_SØ_IND) > 0 THEN                                         
        TP_EGEN   =  F_TP92                                                     
        /*4142*/        (                                                       
                         FNR_R13.ÅR,                                            
                         G,                                                     
                         POREKKE.SPT(BER_SØ_IND),                               
                         POREKKE.OPT(BER_SØ_IND),                               
                         POREKKE.PÅ (BER_SØ_IND),                               
                         POREKKE.PÅ_ETTER91 (BER_SØ_IND),                       
                         100,                                                   
                         100,                                                   
                         'J'                                                    
                        );                                                      
     IF (B02.SIVILSTAND(BER_SØ_IND) = 'S' &                                     
        B02.TP_PROSENT(BER_SØ_IND) = 0)            THEN                         
        DO;  /* SIVILSTADN = 'S' & TP_PROSENT = 0 */                            
           B02.POENGTILLEGG_DATO_ÅMD(BER_SØ_IND) = 0;                           
           B02.POENGTILLEGG_KODE   (BER_SØ_IND) = ' ';                          
           B02.POENGTILLEGG_DATO_ÅMD(BER_EK_IND) = 0;                           
           B02.POENGTILLEGG_KODE   (BER_EK_IND) = ' ';                          
                                                                                
           B02.ALDERSP.SPT(BER_SØ_IND)      = POREKKE.SPT(BER_SØ_IND);          
           B02.ALDERSP.OPT(BER_SØ_IND)      = POREKKE.OPT(BER_SØ_IND);          
           B02.ALDERSP.PÅ(BER_SØ_IND)       = POREKKE.PÅ (BER_SØ_IND);          
           B02.ALDERSP.PÅ_ETTER91(BER_SØ_IND)       =                           
                                  POREKKE.PÅ_ETTER91 (BER_SØ_IND);              
                                                                                
           B02.VT_SPT(BER_SØ_IND)   = POREKKE_P67.SPT(BER_SØ_IND);              
           B02.VT_OPT(BER_SØ_IND)   = POREKKE_P67.OPT(BER_SØ_IND);              
           B02.VT_PÅ (BER_SØ_IND)   = POREKKE_P67.PÅ (BER_SØ_IND);              
                                                                                
           B02.ALDERSP.TP(BER_SØ_IND)         = TP_EGEN;                        
           B02.ETTEPENS.TP_BRUTTO(BER_SØ_IND) = 0;                              
           B02.ETTEPENS.TP_NETTO(BER_SØ_IND)  = 0;                              
           GO TO RETUR;                                                         
        END; /* SIVILSTADN = 'S' & TP_PROSENT = 0 */                            
                                                                                
    IF B02.SIVILSTAND(BER_SØ_IND) ^= 'S'         THEN                           
       B02.TP_PROSENT(BER_SØ_IND) =  55;                                        
    B01_B02_IND     = 2;                                                        
    POTALL_OPPL.IND = BER_EK_IND;                                               
    EXEC CICS LINK PROGRAM ('R0014141') COMMAREA(KOM_OMR);                      
                                                                                
    IF FEIL_MELD_NR > 0  THEN                                                   
       GO TO RETUR;                                                             
    ELSE                                                                        
       PROGRAM_ID = 'R0014101';                                                 
                                                                                
    IF (DØDSÅR < 1992) THEN                                                     
       POREKKE.PÅ_ETTER91(BER_EK_IND) = 0;                                      
                                                                                
  IF (B02.UFØRHIST.UFT_ÅMD(BER_EK_IND,SISTE_UFØRHIST_EK) < 19730000) &          
     (B02.UFØRHIST.UFT_ÅMD(BER_EK_IND,SISTE_UFØRHIST_EK) > 0    ) &             
     ( B02.OPPHØRSKODE(BER_EK_IND,SISTE_UFØRHIST_EK) ^= 'J'    ) &              
     ( B02.PENSJONSTYPE1(BER_EK_IND)                 = 'D')  THEN               
               DO;                                                              
                 POREKKE.PÅ_ETTER91(BER_EK_IND) = 0;                            
                 PÅ_ETTER91_EK = 'N';                                           
               END;                                                             
                                                                                
                                                                                
                                                                                
     B02.ETTEPENS.PÅ_ETTER91(BER_SØ_IND) =                                      
        POREKKE.PÅ_ETTER91(BER_EK_IND);                                         
                                                                                
     IF (FNR_EK_R13.ÅR > 1924)         &                                        
       ((B02.KONV_P_KODE(BER_EK_IND) = 'K' &                                    
         (B02.UTTAKSDATO_ÅMD(BER_EK_IND) < 19920000 &                           
          B02.UTTAKSDATO_ÅMD(BER_EK_IND) > 00000000))  !                        
        ((B02.KONV_P_KODE(BER_EK_IND) = 'U' !                                   
          B02.KONV_P_KODE(BER_EK_IND) = 'Y'  )  &                               
         (B02.UFT_ÅMD(BER_EK_IND,SISTE_UFØRHIST_EK) < 19920000 &                
          B02.UFT_ÅMD(BER_EK_IND,SISTE_UFØRHIST_EK) > 00000000))    !           
        ((B02.UFT_ÅMD(BER_EK_IND,SISTE_UFØRHIST_EK) < 19920000 &                
          B02.UFT_ÅMD(BER_EK_IND,SISTE_UFØRHIST_EK) > 00000000)&                
          B02.OPPHØRSKODE(BER_EK_IND,SISTE_UFØRHIST_EK) = 'A')) THEN            
            DO;                                                                 
               FRADRAG = FNR_EK_R13.ÅR - 1925;                                  
               IF FRADRAG > POREKKE.PÅ_ETTER91(BER_EK_IND)    THEN              
                  B02.ETTEPENS.PÅ_ETTER91(BER_SØ_IND) = 0;                      
               ELSE                                                             
                DO;                                                             
                  B02.ETTEPENS.PÅ_ETTER91(BER_SØ_IND) =                         
                  POREKKE.PÅ_ETTER91(BER_EK_IND) - FRADRAG;                     
                  POREKKE.PÅ_ETTER91(BER_EK_IND) =                              
                  B02.ETTEPENS.PÅ_ETTER91(BER_SØ_IND);                          
                  POREKKE.PÅ_ETTER91(BER_EK_IND + 11) =                         
                  B02.ETTEPENS.PÅ_ETTER91(BER_SØ_IND);                          
                END;                                                            
            END;                                                                
                                                                                
         IF POREKKE.PÅ_ETTER91(BER_EK_IND) ^= 0    THEN                         
            PÅ_ETTER91_EK = 'J';                                                
                                                                                
         IF POREKKE.SPT(BER_SØ_IND) > 0 &                                       
            POREKKE.SPT(BER_EK_IND) > 0       THEN                              
   /*LINJEN NEDENFOR ER FJERNET 200305 - HL - REMEDY 88 */                      
  /* POREKKE(BER_EK_IND + 11) = POREKKE(BER_EK_IND); */                         
  /* OPPDATERING SKJER I 4141 */                                                
     /* PLASS I+11 BRUKES SOM OPPBEVARINGSOMR FOR EKTEFELLEN   */               
                                                                                
  /*DENNE LINJEN BLE LAGT INN IGJEN, OG DERETTER HAR DEN*/                      
  /*FALT UT.  DEN SKAL ALTSÅ VÆRE MED - 200509 HL : */                          
  /* POREKKE(BER_EK_IND + 11) = POREKKE(BER_EK_IND); */                         
                                                                                
            CALL POENG_TILLEGG;                                                 
            /*4143*/                                                            
 /* ENDRET 28.11.86 HL - HVIS ALTERNATIV POREKKE, SOM  EVT. ER    */            
 /*   FRAPP 270          LAGT UT På PLASS 'IND + 11', HAR 'U' I   */            
 /*                      TYPE, Så SKAL ALTERNATIV BEREGNING PRøVES*/            
                                                                                
          IF POREKKE.TYPE(BER_SØ_IND) = 'O' & /* O = ORDINÆR */                 
            (POREKKE.TYPE(BER_SØ_IND + 11)  = ' '  !                            
             POREKKE.TYPE(BER_SØ_IND + 11)  = 'O' ) THEN                        
             DO;  /* IKKE VÆRT UFØR FØR 1973, ORDINÆR BEREGNING */              
                CALL BEREGN_SPT_OPT_PÅ                                          
                        (  /* 4153 */                                           
                         BER_SØ_IND,                                            
                         POREKKE(BER_SØ_IND),                                   
                         W_FNR13                                                
                        ); /* 4153 */                                           
                CALL BEREGN_SPT_OPT_PÅ                                          
                /*4153*/(                                                       
                         BER_SØ_IND,                                            
                         POREKKE_P67(BER_SØ_IND),                               
                         W_FNR13                                                
                        );                                                      
                 POREKKE.PÅ_ETTER91(BER_SØ_IND) =                               
                 B02.ALDERSP.PÅ_ETTER91(BER_SØ_IND);                            
                 POREKKE.PÅ_ETTER91(BER_SØ_IND + 11) =                          
                 B02.ALDERSP.PÅ_ETTER91(BER_SØ_IND);                            
                POREKKE_P67.PÅ_ETTER91(BER_SØ_IND) = 0;                         
                IF PÅ_ETTER91_SØKER = 'N'    THEN                               
                   POREKKE.PÅ_ETTER91(BER_SØ_IND) = 0;                          
                                                                                
                TP_PT_EGEN_55 = F_TP92(FNR_R13.ÅR,G,                            
                                       POREKKE.SPT(BER_SØ_IND),                 
                                       POREKKE.OPT(BER_SØ_IND),                 
                                       POREKKE.PÅ (BER_SØ_IND),                 
                               POREKKE.PÅ_ETTER91 (BER_SØ_IND),                 
                                       100,55,'J');                             
                     /* 4142 */                                                 
                                                                                
             END;                                                               
                                                                                
          ELSE     /* TYPE ER DA U = AP SOM VAR UP FØR 1973 */                  
             DO;                                                                
                CALL BEREGN_SPT_OPT_PÅ_ALT                                      
                /*4156*/(                                                       
                         BER_SØ_IND,                                            
                         POREKKE(BER_SØ_IND),                                   
                         W_FNR13                                                
                        );                                                      
                CALL BEREGN_SPT_OPT_PÅ_ALT                                      
                /*4156*/(                                                       
                         BER_SØ_IND,                                            
                         POREKKE_P67(BER_SØ_IND),                               
                         W_FNR13                                                
                        );                                                      
                 POREKKE.PÅ_ETTER91(BER_SØ_IND) =                               
                 B02.ALDERSP.PÅ_ETTER91(BER_SØ_IND);                            
                 POREKKE.PÅ_ETTER91(BER_SØ_IND + 11) =                          
                 B02.ALDERSP.PÅ_ETTER91(BER_SØ_IND);                            
                POREKKE_P67.PÅ_ETTER91(BER_SØ_IND) = 0;                         
                IF PÅ_ETTER91_SØKER = 'N'    THEN                               
                   POREKKE.PÅ_ETTER91(BER_SØ_IND) = 0;                          
                                                                                
                                                                                
 /*28.11.86 HL- FRAPP 270 - PENSJON ETTER ALTERNATIVE POENGREKKER, */           
 /*              OG MED POENGTILLEGG, SKAL SAMMENLIGNES.           */           
                                                                                
                TP_PT_EGEN_55      = F_TP92(FNR_R13.ÅR,G,                       
                                    POREKKE.SPT(BER_SØ_IND),                    
                                    POREKKE.OPT(BER_SØ_IND),                    
                                    POREKKE.PÅ(BER_SØ_IND),                     
                            POREKKE.PÅ_ETTER91(BER_SØ_IND),                     
                                    100,55,'J');                                
                                                                                
                CALL BEREGN_SPT_OPT_PÅ_ALT                                      
                /*4156*/(                                                       
                         BER_SØ_IND,                                            
                         POREKKE(BER_SØ_IND+11),                                
                         W_FNR13                                                
                        );                                                      
                CALL BEREGN_SPT_OPT_PÅ_ALT                                      
                /*4156*/(                                                       
                         BER_SØ_IND,                                            
                         POREKKE_P67(BER_SØ_IND+11),                            
                         W_FNR13                                                
                        );                                                      
                 POREKKE.PÅ_ETTER91(BER_SØ_IND) =                               
                 B02.ALDERSP.PÅ_ETTER91(BER_SØ_IND);                            
                 POREKKE.PÅ_ETTER91(BER_SØ_IND + 11) =                          
                 B02.ALDERSP.PÅ_ETTER91(BER_SØ_IND);                            
                POREKKE_P67.PÅ_ETTER91(BER_SØ_IND + 11) = 0;                    
                IF PÅ_ETTER91_SØKER = 'N'    THEN                               
                   POREKKE.PÅ_ETTER91(BER_SØ_IND + 11)  = 0;                    
                                                                                
                                                                                
                W_TP_ALT        = F_TP92(FNR_R13.ÅR,G,                          
                                    POREKKE.SPT(BER_SØ_IND + 11),               
                                    POREKKE.OPT(BER_SØ_IND + 11),               
                                    POREKKE.PÅ(BER_SØ_IND + 11),                
                            POREKKE.PÅ_ETTER91(BER_SØ_IND + 11),                
                                    100,55,'J');                                
                                                                                
                IF W_TP_ALT > TP_PT_EGEN_55          THEN                       
                   DO;                                                          
                      POREKKE(BER_SØ_IND) =                                     
                                     POREKKE(BER_SØ_IND + 11);                  
                      POREKKE_P67(BER_SØ_IND) =                                 
                                     POREKKE_P67(BER_SØ_IND + 11);              
                      TP_PT_EGEN_55         = W_TP_ALT;                         
                   END;                                                         
             END;                                                               
 /* ENDRET 11.12.86 HL - HVIS ALTERNATIV POREKKE, SOM EVT. ER     */            
 /*   FRAPP 270          LAGT UT På PLASS 'IND + 11', IKKE HAR 'O'*/            
 /*                    I TYPE, Så SKAL ALTERNATIV BEREGNING PRøVES*/            
          IF POREKKE.TYPE(BER_EK_IND) = 'O' &                                   
             POREKKE.TYPE(BER_EK_IND + 11) ^= 'D'  THEN                         
                                       /* O = ORDINÆR */                        
             DO;                                                                
                CALL BEREGN_SPT_OPT_PÅ                                          
                /*4153*/(                                                       
                         BER_EK_IND,                                            
                         POREKKE(BER_EK_IND),                                   
                         W_FNR_EK13                                             
                        );                                                      
                POREKKE.PÅ_ETTER91(BER_EK_IND) =                                
                B02.ETTEPENS.PÅ_ETTER91(BER_SØ_IND);                            
                POREKKE.PÅ_ETTER91(BER_EK_IND + 11) =                           
                B02.ETTEPENS.PÅ_ETTER91(BER_SØ_IND);                            
                IF PÅ_ETTER91_EK = 'N'             THEN                         
                   POREKKE.PÅ_ETTER91(BER_EK_IND) = 0;                          
                TP_EK_PT = F_TP92                                               
                      /*4142*/(                                                 
                               FNR_EK_R13.ÅR,                                   
                               G,                                               
                               POREKKE.SPT(BER_EK_IND),                         
                               POREKKE.OPT(BER_EK_IND),                         
                               POREKKE.PÅ (BER_EK_IND),                         
                               POREKKE.PÅ_ETTER91(BER_EK_IND),                  
                               100,                                             
                               (B02.TP_PROSENT(BER_SØ_IND)),                    
                               'J'                                              
                              );                                                
             END;                                                               
          ELSE     /* TYPE ER DA U =  AP SOM VAR UP FØR 1973 */                 
                   /* ELLER      D = DØD SOM VAR UP FØR 1973 */                 
                                                                                
             DO;                                                                
                CALL BEREGN_SPT_OPT_PÅ_ALT                                      
                /*4156*/(                                                       
                         BER_EK_IND,                                            
                         POREKKE(BER_EK_IND),                                   
                         W_FNR_EK13                                             
                        );                                                      
                CALL BEREGN_SPT_OPT_PÅ_ALT                                      
                /*4156*/(                                                       
                         BER_EK_IND,                                            
                         POREKKE(BER_EK_IND+11),                                
                         W_FNR_EK13                                             
                        );                                                      
                                                                                
                POREKKE.PÅ_ETTER91(BER_EK_IND) =                                
                B02.ETTEPENS.PÅ_ETTER91(BER_SØ_IND);                            
                POREKKE.PÅ_ETTER91(BER_EK_IND + 11) =                           
                B02.ETTEPENS.PÅ_ETTER91(BER_SØ_IND);                            
                IF PÅ_ETTER91_EK = 'N'             THEN                         
                   DO;                                                          
                      POREKKE.PÅ_ETTER91(BER_EK_IND) = 0;                       
                      POREKKE.PÅ_ETTER91(BER_EK_IND + 11) = 0;                  
                   END;                                                         
                                                                                
                                                                                
 /*11.12.86 HL- FRAPP 270 - PENSJON ETTER ALTERNATIVE POENGREKKER, */           
 /*              OG MED POENGTILLEGG, SKAL SAMMENLIGNES.           */           
                                                                                
                W_TP = F_TP92                                                   
                          (                                                     
                           FNR_EK_R13.ÅR,                                       
                           G,                                                   
                           POREKKE.SPT(BER_EK_IND),                             
                           POREKKE.OPT(BER_EK_IND),                             
                           POREKKE.PÅ(BER_EK_IND),                              
                           POREKKE.PÅ_ETTER91(BER_EK_IND),                      
                           100,                                                 
                           (B02.TP_PROSENT(BER_SØ_IND)),                        
                           'J'                                                  
                          );                                                    
                W_TP_ALT = F_TP92                                               
                              (                                                 
                               FNR_EK_R13.ÅR,                                   
                               G,                                               
                               POREKKE.SPT(BER_EK_IND + 11),                    
                               POREKKE.OPT(BER_EK_IND + 11),                    
                               POREKKE.PÅ(BER_EK_IND + 11),                     
                               POREKKE.PÅ_ETTER91(BER_EK_IND + 11),             
                               100,                                             
                               (B02.TP_PROSENT(BER_SØ_IND)),                    
                               'J'                                              
                              );                                                
                IF (W_TP_ALT > W_TP) THEN                                       
                   DO;                                                          
                      POREKKE(BER_EK_IND) = POREKKE(BER_EK_IND + 11);           
                      POREKKE_P67(BER_EK_IND) =                                 
                                          POREKKE_P67(BER_EK_IND + 11);         
                      TP_EK_PT = W_TP_ALT;                                      
                   END;                                                         
                ELSE                                                            
                   TP_EK_PT = W_TP;                                             
                                                                                
             END;                                                               
 /* ************************************************************* */            
 /*ENDRET 0388 HL : ETT ALTERNATIV ER AT AVDØDES POENG IKKE ENDRES*/            
 /* ************************************************************* */            
                                                                                
         IF (B01.UFØRPENS.UFG(BER_EK_IND) > 0) THEN                             
            W2_TP     = F_TP92(FNR_EK_R13.ÅR,G,                                 
                          (B01.UFØRPENS.SPT(BER_EK_IND)),                       
                          (B01.UFØRPENS.OPT(BER_EK_IND)),                       
                          (B01.UFØRPENS.PÅ(BER_EK_IND)),                        
                          (B01.UFØRPENS.PÅ_ETTER91(BER_EK_IND)),                
                          100,                                                  
                          (B02.TP_PROSENT(BER_SØ_IND)),'J');                    
                                                                                
         IF W2_TP > TP_EK_PT THEN                                               
                                                                                
            DO;                                                                 
               TP_EK_PT = W2_TP;                  /*200201*/                    
               B02.ETTEPENS.SPT_AVD(BER_SØ_IND) =                               
                       B01.UFØRPENS.SPT(BER_EK_IND);                            
               B02.ETTEPENS.OPT_AVD(BER_SØ_IND) =                               
                       B01.UFØRPENS.OPT(BER_EK_IND);                            
               B02.ETTEPENS.PÅ_AVD(BER_SØ_IND)  =                               
                       B01.UFØRPENS.PÅ(BER_EK_IND);                             
               B02.ETTEPENS.PÅ_ETTER91(BER_SØ_IND)  =                           
                       B01.UFØRPENS.PÅ_ETTER91(BER_EK_IND);                     
                                                                                
            END;                                                                
                                                                                
         ELSE                                                                   
                                                                                
           DO;                                                                  
             B02.ETTEPENS.SPT_AVD(BER_SØ_IND) = POREKKE.SPT(BER_EK_IND);        
             B02.ETTEPENS.OPT_AVD(BER_SØ_IND) = POREKKE.OPT(BER_EK_IND);        
             B02.ETTEPENS.PÅ_AVD(BER_SØ_IND)  = POREKKE.PÅ (BER_EK_IND);        
             B02.ETTEPENS.PÅ_ETTER91(BER_SØ_IND) =                              
                         POREKKE.PÅ_ETTER91 (BER_EK_IND);                       
                                                                                
           END;                                                                 
                                                                                
   /* OPPDATERING AV ALDERSP.PÅ_ETTER91 MANGLER DER PÅE91 = 0 */                
                                                                                
                                                                                
   IF  PÅ_ETTER91_SØKER = 'N'  THEN                                             
       B02.ALDERSP.PÅ_ETTER91(BER_SØ_IND)   = 0;                                
                                                                                
 /* ************************************************************ */             
 /* YS - TILLEGG. AVDØDES YPT OPPDATERES VED NY SKADE            */             
 /*      KAP11-PENSJON BEREGNES EVT. FOR AVDØDE                  */             
 /* ************************************************************ */             
                                                                                
         IF B02.YRKEPENS.YUG(BER_EK_IND) > 0 THEN                               
            DO;                                                                 
                                                                                
        DCL KAP11_TP_BRUTTO       FIXED DEC (5);                                
        DCL W_KAP11_TP_BRUTTO       FIXED DEC (11,4) INIT(0);  /*TS*/           
        DCL VANLIG_TP_BRUTTO      FIXED DEC (5);                                
                                                                                
               IF B02.YRKEPENS.YUG(BER_EK_IND)  = 100   &                       
                  B01.YRKEPENS.YUG(BER_EK_IND) ^= 100 THEN                      
                  DO;                                                           
                     IF B02.YRKEPENS.YPT(BER_EK_IND) <                          
                        B02.SPT_AVD(BER_SØ_IND)     THEN                        
                        DO;                                                     
                           B02.YRKEPENS.YPT(BER_EK_IND) =                       
                           B02.SPT_AVD(BER_SØ_IND);                             
                           B02.YRKEPENS.YPT_KODE(BER_EK_IND) = 'V';             
                        END;                                                    
                  END;                                                          
                                                                                
                                                                                
             W_KAP11_TP_BRUTTO =  G * B02.YRKEPENS.YPT(BER_EK_IND);             
             W_KAP11_TP_BRUTTO =  W_KAP11_TP_BRUTTO *                           
                                  B02.YRKEPENS.YUG(BER_EK_IND)/100;             
             W_KAP11_TP_BRUTTO =  W_KAP11_TP_BRUTTO *                           
                                  B02.TP_PROSENT(BER_SØ_IND) /100;              
             W_KAP11_TP_BRUTTO =  W_KAP11_TP_BRUTTO / 12;                       
             IF B02.YRKEPENS.PÅ_ETTER91(BER_EK_IND) = 0     THEN                
                W_KAP11_TP_BRUTTO   =  W_KAP11_TP_BRUTTO * 0.45;                
             ELSE                                                               
             DO;                                                                
                FAKTOR1 = (B02.YRKEPENS.PÅ(BER_EK_IND)                          
                           - B02.YRKEPENS.PÅ_ETTER91(BER_EK_IND) )              
                           / B02.YRKEPENS.PÅ(BER_EK_IND) * 0.45;                
                FAKTOR2 =  B02.YRKEPENS.PÅ_ETTER91(BER_EK_IND)                  
                           / B02.YRKEPENS.PÅ(BER_EK_IND) * 0.42;                
                W_KAP11_TP_BRUTTO=                                              
                  W_KAP11_TP_BRUTTO * (FAKTOR1 + FAKTOR2 + 0.0000005);          
             END;                                                               
             KAP11_TP_BRUTTO   =  W_KAP11_TP_BRUTTO + 0.5;                      
                                                                                
                                                                                
                                                                                
               VANLIG_TP_BRUTTO = TP_EK_PT *                                    
                         B02.YRKEPENS.YUG(BER_EK_IND) / 100 + 0.5;              
                                                                                
               IF KAP11_TP_BRUTTO > VANLIG_TP_BRUTTO       THEN                 
                  DO;                                                           
                     DIV_PARAM_OMR.BEREGNINGS_ALT_AVD = '3';                    
                                                                                
                     TP_EK_PT = TP_EK_PT + KAP11_TP_BRUTTO -                    
                                VANLIG_TP_BRUTTO;                               
                  END;                                                          
                                                                                
            END;                                                                
                                                                                
  DØDSDATO_ÅMD = B02.DØDSDATO_ÅMD(BER_EK_IND);                                  
  FIXED_DEC7  = F_ALDER(W_FNR_EK,(DØDSDATO_ÅMD));                               
  ALDER_VED_DØD = FIXED_DEC7;                                                   
  W_VIRK_ÅM   = B02.VIRK_DATO_ÅMD(BER_SØ_IND) / 100; /*0011*/                   
                                                                                
  /* GARANTI FOR GAMLE UNGE UFØRE FØDT FØR 1943 */                              
  /*LEGGES INN 040892 TRUDE                    */                               
                                                                                
  IF B02.BUP_GAR_KODE(BER_EK_IND,1)  = 'E' THEN                                 
     CALL SPT_GARANTI_E(FNR_EK_R13.ÅR,                                          
  /*          (B02.VIRK_DATO_ÅMD(BER_SØ_IND)),RETUR_POENG);   4199*/            
              (W_VIRK_ÅM),RETUR_POENG); /*4199*/                                
  ELSE                                                                          
  IF B02.TP_GAR_KODE(BER_EK_IND) = 'E'     THEN                                 
     CALL UNGE_DØDE_E((B02.VIRK_DATO_ÅMD(BER_SØ_IND)),                          
            FNR_EK_R13.ÅR,(ALDER_VED_DØD),RETUR_POENG); /*4327*/                
                                                                                
  IF RETUR_POENG > 0                      THEN                                  
    DO;                                                                         
                                                                                
      W_GARANTI_TP      =  G * 0.45 * RETUR_POENG;                              
      W_GARANTI_TP      =  W_GARANTI_TP * B02.TT_ANV(BER_EK_IND) / 40;          
      W_GARANTI_TP      =  W_GARANTI_TP / 100;                                  
      W_GARANTI_TP      =  W_GARANTI_TP * B02.TP_PROSENT(BER_SØ_IND);           
      W_GARANTI_TP      =  W_GARANTI_TP / 12 ;                                  
      W_GAR_TP          = W_GARANTI_TP + 0.5;                                   
                                                                                
      IF W_GAR_TP  >  TP_EK_PT THEN                                             
         TP_EK_PT  = W_GAR_TP;                                                  
    END;                                                                        
    RETUR_POENG = 0;                                                            
                                                                                
                                                                                
         IF B02.BUP_GAR_KODE(BER_SØ_IND,1)    =   'E'   THEN                    
            CALL SPT_GARANTI_E(FNR_R13.ÅR,                                      
   /*         (B02.VIRK_DATO_ÅMD(BER_SØ_IND)),RETUR_POENG);   4199*/            
              (W_VIRK_ÅM),RETUR_POENG); /*4199*/                                
                                                                                
     IF RETUR_POENG > 0 THEN                                                    
       DO;                                                                      
       TP_GARANTI  = ( RETUR_POENG * 0.45 * G );                                
       TP_GARANTI  = TP_GARANTI / 40;                                           
       TP_GARANTI  = TP_GARANTI * B02.TT_ANV(BER_SØ_IND);                       
       TP_GARANTI  = TP_GARANTI / 12;                                           
       TP_GARANTI    = TP_GARANTI + 0.5;                                        
                                                                                
         IF TP_GARANTI  >   TP_EGEN  THEN                                       
             DO;                                                                
                /* HER SKAL IKKE TP_PT_EGEN_55 OPPDATERES DA 55%'S- */          
                /* REGELEN BARE GJELDER "OPPTJENT" TILLEGGSPENSJON  */          
                /* SE PENSJONSBEREGNINGSPERMEN PUNKT 13.1.3         */          
                TP_EGEN     = TP_GARANTI;                                       
                B02.STATUS.TP_GAR_KODE(BER_SØ_IND)  = 'E';                      
             END;                                                               
       END;                                                                     
                                                                                
                    /*UF BLE FEIL VED OVERGANG TIL P67  */                      
                    /*TRUDE, 8.1.90 TIL HIT             */                      
                                                                                
                                                                                
 RETUR:                                                                         
                                                                                
 END BEREGN_TP_ETTERLATT_AP;                                                    
